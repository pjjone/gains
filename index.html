
<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#0d0d12">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#f4f4f8">
<title>GAINS</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ===== DARK THEME (default) ===== */
:root {
  --bg:#0d0d12;--s1:#14141c;--s2:#1e1e2a;--s3:#28283a;--border:#2e2e42;
  --accent:#b8ff3c;--accent-text:#0d0d12;--purple:#7c5cfc;
  --text:#eeeef8;--muted:#6a6a85;
  --danger:#ff4d6d;--green:#06d6a0;--orange:#ff9f43;--r:14px;
  --shadow:0 2px 12px rgba(0,0,0,.4);
}
/* ===== LIGHT THEME ===== */
@media(prefers-color-scheme:light){
  :root{
    --bg:#f4f4f8;--s1:#ffffff;--s2:#f0f0f5;--s3:#e4e4ec;--border:#dcdce8;
    --accent:#5a9e00;--accent-text:#ffffff;--purple:#6b44e8;
    --text:#1a1a2e;--muted:#8888a0;
    --danger:#d63050;--green:#059669;--orange:#d97706;
    --shadow:0 2px 12px rgba(0,0,0,.08);
  }
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;overflow:hidden;}
#app{display:flex;flex-direction:column;height:100dvh;max-width:430px;margin:0 auto;position:relative;}
.screen{flex:1;overflow-y:auto;overflow-x:hidden;padding:0 0 24px;display:none;flex-direction:column;}
.screen.active{display:flex;}
.screen::-webkit-scrollbar{display:none;}
.topbar{padding:env(safe-area-inset-top,44px) 20px 16px;background:var(--s1);position:sticky;top:0;z-index:20;display:flex;justify-content:space-between;align-items:flex-end;border-bottom:1px solid var(--border);}
.topbar-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:3px;color:var(--accent);line-height:1;}
.topbar-sub{font-size:12px;color:var(--muted);margin-top:2px;}
.icon-btn{width:38px;height:38px;border-radius:50%;background:var(--s2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;color:var(--text);flex-shrink:0;}
.nav{display:flex;background:var(--s1);border-top:1px solid var(--border);padding-bottom:env(safe-area-inset-bottom,0);flex-shrink:0;z-index:20;}
.nav-btn{flex:1;padding:12px 0 10px;border:none;background:transparent;display:flex;flex-direction:column;align-items:center;gap:4px;cursor:pointer;color:var(--muted);transition:color .2s;font-family:'DM Sans',sans-serif;font-size:10px;font-weight:500;}
.nav-btn svg{width:22px;height:22px;}
.nav-btn.active{color:var(--accent);}
.sec{padding:0 20px;margin-bottom:8px;margin-top:20px;display:flex;justify-content:space-between;align-items:center;}
.sec-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;color:var(--muted);}
.sec-action{font-size:12px;color:var(--accent);font-weight:600;cursor:pointer;}
.card{margin:0 20px 10px;background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:16px;position:relative;overflow:hidden;box-shadow:var(--shadow);}
.btn{display:block;width:100%;padding:14px;border:none;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:all .15s;text-align:center;}
.btn-primary{background:var(--accent);color:var(--accent-text);}
.btn-primary:active{transform:scale(0.98);}
.btn-ghost{background:var(--s2);border:1px solid var(--border);color:var(--text);}
.btn-danger{background:transparent;border:1px solid var(--danger);color:var(--danger);}
.btn-export{background:var(--s2);border:2px solid var(--accent);color:var(--accent);}
.btn-sm{padding:8px 16px;font-size:13px;width:auto;display:inline-block;}
.input{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:12px 14px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;}
.input:focus{outline:none;border-color:var(--accent);}
.input::placeholder{color:var(--muted);}
textarea.input{resize:none;min-height:64px;line-height:1.5;}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;justify-content:center;z-index:100;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--s1);border:1px solid var(--border);border-radius:20px 20px 0 0;padding:24px 20px;padding-bottom:calc(env(safe-area-inset-bottom,0px) + 24px);width:100%;max-width:430px;max-height:92dvh;overflow-y:auto;}
.modal::-webkit-scrollbar{display:none;}
.modal-title{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;margin-bottom:16px;}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:0 auto 20px;}
.prog-card{margin:0 20px 10px;background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:16px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:border-color .2s;box-shadow:var(--shadow);}
.prog-card:active{border-color:var(--accent);}
.prog-icon{width:48px;height:48px;border-radius:12px;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;}
.prog-info{flex:1;min-width:0;}
.prog-name{font-weight:600;font-size:16px;}
.prog-exercises{font-size:12px;color:var(--muted);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.prog-actions{display:flex;gap:8px;}
.prog-act-btn{width:32px;height:32px;border-radius:50%;border:1px solid var(--border);background:var(--s2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--muted);}
.exlib-item{margin:0 0 8px;background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;}
.exlib-name{font-weight:500;font-size:14px;}
.exlib-cat{font-size:11px;color:var(--muted);margin-top:2px;}
.ex-block{margin:0 20px 12px;background:var(--s1);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--shadow);}
.ex-block-head{padding:14px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);}
.ex-block-name{font-weight:600;font-size:15px;}
.ex-block-prev{font-size:11px;color:var(--muted);margin-top:2px;}
.sets-table{padding:12px 16px 8px;}
.sets-row{display:grid;grid-template-columns:28px 1fr 1fr 36px;gap:8px;align-items:center;margin-bottom:8px;}
.sets-head{font-size:11px;color:var(--muted);text-align:center;margin-bottom:8px;}
.set-n{width:28px;height:28px;border-radius:50%;background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted);font-weight:700;flex-shrink:0;}
.set-n.done{background:var(--accent);color:var(--accent-text);}
.set-input{background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:8px 4px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;text-align:center;width:100%;-webkit-appearance:none;}
.set-input:focus{outline:none;border-color:var(--accent);}
.check-set{width:36px;height:36px;border-radius:50%;border:2px solid var(--border);background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;color:var(--muted);transition:all .15s;flex-shrink:0;}
.check-set.done{background:var(--accent);border-color:var(--accent);color:var(--accent-text);}
.note-row{padding:0 16px 12px;}
.note-input{width:100%;background:var(--s2);border:1px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;resize:none;min-height:52px;line-height:1.5;}
.note-input:focus{outline:none;border-color:var(--accent);}
.note-input::placeholder{color:var(--muted);}
.add-set-btn{margin:0 16px 12px;padding:8px;border:1px dashed var(--border);border-radius:10px;background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;width:calc(100% - 32px);}
.hist-date{font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;color:var(--muted);padding:0 20px;margin-top:18px;margin-bottom:8px;}
.hist-card{margin:0 20px 10px;background:var(--s1);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;cursor:pointer;transition:border-color .2s;box-shadow:var(--shadow);}
.hist-card:active{border-color:var(--accent);}
.hist-card-top{display:flex;justify-content:space-between;margin-bottom:6px;}
.hist-card-name{font-weight:600;font-size:15px;}
.hist-card-time{font-size:12px;color:var(--muted);}
.hist-card-exercises{font-size:12px;color:var(--muted);line-height:1.6;}
.hist-card-stats{display:flex;gap:12px;margin-top:10px;}
.hist-stat{font-size:11px;color:var(--muted);}
.hist-stat span{color:var(--text);font-weight:600;}
.workout-topbar{padding:env(safe-area-inset-top,44px) 20px 16px;background:var(--s1);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:20;flex-shrink:0;}
.workout-info{flex:1;}
.workout-name-label{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--accent);}
.workout-timer{font-size:12px;color:var(--muted);margin-top:2px;}
.timer-display{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--text);}
.empty-state{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-state .icon{font-size:48px;margin-bottom:16px;}
.empty-state p{font-size:14px;line-height:1.6;}
.chip{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;background:var(--s2);border:1px solid var(--border);color:var(--muted);cursor:pointer;white-space:nowrap;transition:all .15s;}
.chip.selected{background:var(--purple);border-color:var(--purple);color:#fff;}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;background:var(--accent);color:var(--accent-text);}
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--s3);border:1px solid var(--border);border-radius:12px;padding:10px 20px;font-size:13px;font-weight:600;z-index:200;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;box-shadow:var(--shadow);}
.toast.show{opacity:1;}
.export-banner{margin:0 20px 10px;background:var(--s1);border:2px solid var(--accent);border-radius:var(--r);padding:14px 16px;display:flex;align-items:center;gap:12px;cursor:pointer;}
.export-banner-text{flex:1;}
.export-banner-title{font-weight:600;font-size:14px;color:var(--accent);}
.export-banner-sub{font-size:12px;color:var(--muted);margin-top:2px;}
.label{font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:500;}
</style>
</head>
<body>
<div id="app">

<!-- HOME -->
<div class="screen active" id="screen-home">
  <div class="topbar">
    <div><div class="topbar-title">GAINS</div><div class="topbar-sub" id="home-date"></div></div>
    <div class="icon-btn" onclick="openExportModal()">üíæ</div>
  </div>
  <!-- Export reminder banner -->
  <div id="export-reminder" style="display:none;margin-top:12px;">
    <div class="export-banner" onclick="openExportModal()">
      <div style="font-size:24px;">üíæ</div>
      <div class="export-banner-text">
        <div class="export-banner-title">–ù–µ –∑–∞–±—É–¥—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ!</div>
        <div class="export-banner-sub">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
      </div>
      <div style="font-size:18px;color:var(--muted)">‚Üí</div>
    </div>
  </div>
  <div class="sec"><div class="sec-title">–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç</div></div>
  <div style="padding:0 20px;">
    <button class="btn btn-primary" onclick="openStartWorkoutModal()" style="margin-bottom:10px;">‚ñ∂ –ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</button>
  </div>
  <div class="sec"><div class="sec-title">–ú–æ–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã</div><div class="sec-action" onclick="switchTab('programs')">–í—Å–µ ‚Üí</div></div>
  <div id="home-programs-list"></div>
  <div class="sec"><div class="sec-title">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div><div class="sec-action" onclick="switchTab('history')">–ò—Å—Ç–æ—Ä–∏—è ‚Üí</div></div>
  <div id="home-last-workout"></div>
  <div class="sec"><div class="sec-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div></div>
  <div style="padding:0 20px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px;">
    <div class="card" style="margin:0;text-align:center;padding:14px 8px;"><div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--accent)" id="stat-total">0</div><div style="font-size:11px;color:var(--muted)">–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>
    <div class="card" style="margin:0;text-align:center;padding:14px 8px;"><div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--purple)" id="stat-week">0</div><div style="font-size:11px;color:var(--muted)">–ù–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ</div></div>
    <div class="card" style="margin:0;text-align:center;padding:14px 8px;"><div style="font-family:'Bebas Neue',sans-serif;font-size:28px;color:var(--orange)" id="stat-streak">0</div><div style="font-size:11px;color:var(--muted)">–î–Ω–µ–π –ø–æ–¥—Ä—è–¥</div></div>
  </div>
</div>

<!-- ACTIVE WORKOUT -->
<div class="screen" id="screen-workout" style="padding:0;">
  <div class="workout-topbar">
    <div class="workout-info">
      <div class="workout-name-label" id="aw-program-name">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</div>
      <div class="workout-timer">–í—Ä–µ–º—è: <span class="timer-display" id="aw-timer">00:00</span></div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-sm btn-primary" onclick="finishWorkout()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <div class="icon-btn" onclick="cancelWorkout()">‚úï</div>
    </div>
  </div>
  <div id="aw-exercises" style="padding-top:12px;flex:1;overflow-y:auto;"></div>
  <div style="padding:12px 20px 24px;">
    <button class="btn btn-ghost" onclick="addExToWorkout()">+ –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
  </div>
</div>

<!-- HISTORY -->
<div class="screen" id="screen-history">
  <div class="topbar"><div><div class="topbar-title">–ò—Å—Ç–æ—Ä–∏—è</div><div class="topbar-sub">–í—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏</div></div></div>
  <div id="history-list"></div>
</div>

<!-- PROGRAMS -->
<div class="screen" id="screen-programs">
  <div class="topbar">
    <div><div class="topbar-title">–ü—Ä–æ–≥—Ä–∞–º–º—ã</div><div class="topbar-sub">–¢–≤–æ–∏ —Å–µ—Ç—ã —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div></div>
    <div class="icon-btn" onclick="openNewProgramModal()">Ôºã</div>
  </div>
  <div id="programs-list"></div>
  <div style="padding:8px 20px 16px;"><button class="btn btn-ghost" onclick="openNewProgramModal()">+ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É</button></div>
  <div class="sec" style="margin-top:8px;"><div class="sec-title">–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div><div class="sec-action" onclick="openExerciseLibModal()">–û—Ç–∫—Ä—ã—Ç—å ‚Üí</div></div>
  <div id="exercises-preview"></div>
</div>

<!-- NAV -->
<nav class="nav" id="main-nav">
  <button class="nav-btn active" onclick="switchTab('home')" id="nav-home">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>–ì–ª–∞–≤–Ω–∞—è
  </button>
  <button class="nav-btn" onclick="switchTab('history')" id="nav-history">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>–ò—Å—Ç–æ—Ä–∏—è
  </button>
  <button class="nav-btn" onclick="switchTab('programs')" id="nav-programs">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>–ü—Ä–æ–≥—Ä–∞–º–º—ã
  </button>
</nav>
</div>

<!-- MODAL: Start -->
<div class="modal-overlay" id="modal-start">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–ù–∞—á–∞—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É</div>
    <div id="start-programs-list" style="margin-bottom:10px;"></div>
    <button class="btn btn-ghost" onclick="startFreeWorkout()" style="margin-bottom:10px;">üèÉ –°–≤–æ–±–æ–¥–Ω–∞—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
    <button class="btn btn-danger btn-sm" onclick="closeModal('modal-start')">–û—Ç–º–µ–Ω–∞</button>
  </div>
</div>

<!-- MODAL: New/Edit Program -->
<div class="modal-overlay" id="modal-new-program">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-prog-title">–ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</div>
    <div style="margin-bottom:12px;">
      <div class="label">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
      <input class="input" id="prog-name-input" placeholder="–°–ø–∏–Ω–∞, –ù–æ–≥–∏, –ì—Ä—É–¥—å‚Ä¶">
    </div>
    <div style="margin-bottom:12px;">
      <div class="label">–ò–∫–æ–Ω–∫–∞</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;" id="icon-picker"></div>
      <input type="hidden" id="prog-icon-val" value="üèãÔ∏è">
    </div>
    <div style="margin-bottom:16px;">
      <div class="label">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è <span class="badge" id="prog-ex-count">0</span></div>
      <div id="prog-ex-list" style="margin-bottom:10px;max-height:200px;overflow-y:auto;"></div>
      <button class="btn btn-ghost btn-sm" onclick="openPickExerciseModal('program')">+ –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</button>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" onclick="saveProgram()" style="flex:1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn btn-ghost" onclick="closeModal('modal-new-program')" style="flex:1">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- MODAL: Exercise Library -->
<div class="modal-overlay" id="modal-exlib">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è</div>
    <input class="input" placeholder="–ü–æ–∏—Å–∫‚Ä¶" id="exlib-search" oninput="renderExLibModal()" style="margin-bottom:12px;">
    <div id="exlib-modal-list" style="max-height:240px;overflow-y:auto;margin-bottom:14px;"></div>
    <div class="label" style="font-weight:600;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ:</div>
    <input class="input" id="new-ex-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è" style="margin-bottom:10px;margin-top:6px;">
    <div class="label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</div>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px;margin-top:6px;" id="cat-picker"></div>
    <input type="hidden" id="new-ex-cat" value="–î—Ä—É–≥–æ–µ">
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary" onclick="createExercise()" style="flex:1">–°–æ–∑–¥–∞—Ç—å</button>
      <button class="btn btn-ghost" onclick="closeModal('modal-exlib')" style="flex:1">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- MODAL: Pick Exercise -->
<div class="modal-overlay" id="modal-pick-ex">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">–í—ã–±—Ä–∞—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</div>
    <input class="input" placeholder="–ü–æ–∏—Å–∫‚Ä¶" id="pick-ex-search" oninput="renderPickExModal()" style="margin-bottom:10px;">
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;overflow-x:auto;padding-bottom:4px;" id="pick-ex-cats"></div>
    <div id="pick-ex-list" style="max-height:360px;overflow-y:auto;"></div>
    <div style="height:12px;"></div>
    <button class="btn btn-ghost" onclick="closeModal('modal-pick-ex')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- MODAL: History Detail -->
<div class="modal-overlay" id="modal-hist-detail">
  <div class="modal">
    <div class="modal-handle"></div>
    <div id="hist-detail-content"></div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button class="btn btn-sm btn-danger" onclick="deleteWorkoutFromDetail()">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn btn-ghost" onclick="closeModal('modal-hist-detail')" style="flex:1">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- MODAL: Export/Import -->
<div class="modal-overlay" id="modal-export">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</div>
    <div style="background:var(--s2);border-radius:12px;padding:14px;margin-bottom:16px;font-size:13px;color:var(--muted);line-height:1.6;">
      –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π —Ñ–∞–π–ª ‚Äî –æ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç –≤—Å–µ —Ç–≤–æ–∏ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ.
    </div>
    <div style="margin-bottom:10px;">
      <button class="btn btn-primary" onclick="exportData()" style="margin-bottom:8px;">üì§ –≠–∫—Å–ø–æ—Ä—Ç ‚Äî —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª</button>
      <div style="font-size:11px;color:var(--muted);text-align:center;margin-bottom:14px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç —Ñ–∞–π–ª gains-backup.json</div>
    </div>
    <div style="border-top:1px solid var(--border);padding-top:16px;margin-bottom:10px;">
      <div class="label" style="margin-bottom:8px;">üì• –ò–º–ø–æ—Ä—Ç ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞:</div>
      <label style="display:block;width:100%;padding:14px;border:2px dashed var(--border);border-radius:12px;text-align:center;cursor:pointer;font-size:14px;color:var(--muted);">
        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª gains-backup.json
        <input type="file" accept=".json" id="import-file" style="display:none;" onchange="importData(this)">
      </label>
      <div style="font-size:11px;color:var(--danger);margin-top:6px;">‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ</div>
    </div>
    <button class="btn btn-ghost" onclick="closeModal('modal-export')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const CATEGORIES=['–°–ø–∏–Ω–∞','–ù–æ–≥–∏','–ì—Ä—É–¥—å','–ü–ª–µ—á–∏','–ë–∏—Ü–µ–ø—Å','–¢—Ä–∏—Ü–µ–ø—Å','–ü—Ä–µ—Å—Å','–ö–∞—Ä–¥–∏–æ','–î—Ä—É–≥–æ–µ'];
const ICONS=['üèãÔ∏è','ü¶µ','üí™','ü´Å','ü§∏','üèÉ','üßò','ü•ä','üö¥','üèä','‚ö°','üî•','ü¶æ','üéØ'];

let state={exercises:[],programs:[],workouts:[]};
let activeWorkout=null;
let editingProgramId=null;
let pickExTarget='program';
let pickExCat='';
let tempProgExercises=[];
let currentHistDetailId=null;

function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36);}
function save(){localStorage.setItem('gains_v2',JSON.stringify(state));}
function load(){
  const d=localStorage.getItem('gains_v2');
  if(d){state={exercises:[],programs:[],workouts:[],...JSON.parse(d)};}
  else{
    state.exercises=[
      {id:'e1',name:'–¢—è–≥–∞ –≤–µ—Ä—Ö–Ω–µ–≥–æ –±–ª–æ–∫–∞',category:'–°–ø–∏–Ω–∞'},
      {id:'e2',name:'–¢—è–≥–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–ª–æ–∫–∞',category:'–°–ø–∏–Ω–∞'},
      {id:'e3',name:'–ì–∏–ø–µ—Ä—ç–∫—Å—Ç–µ–Ω–∑–∏—è',category:'–°–ø–∏–Ω–∞'},
      {id:'e4',name:'–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞',category:'–ì—Ä—É–¥—å'},
      {id:'e5',name:'–†–∞–∑–≤–æ–¥–∫–∞ –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞',category:'–ì—Ä—É–¥—å'},
      {id:'e6',name:'–ü—Ä–∏—Å–µ–¥–∞–Ω–∏—è',category:'–ù–æ–≥–∏'},
      {id:'e7',name:'–ñ–∏–º –Ω–æ–≥–∞–º–∏',category:'–ù–æ–≥–∏'},
      {id:'e8',name:'–ò–∫—Ä—ã —Å–∏–¥—è',category:'–ù–æ–≥–∏'},
      {id:'e9',name:'–ü–æ–¥—ä—ë–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞ –±–∏—Ü–µ–ø—Å',category:'–ë–∏—Ü–µ–ø—Å'},
      {id:'e10',name:'–†–∞–∑–≤–æ–¥–∫–∞ –≥–∞–Ω—Ç–µ–ª–µ–π –≤ —Å—Ç–æ—Ä–æ–Ω—ã',category:'–ü–ª–µ—á–∏'},
      {id:'e11',name:'–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –≤–≤–µ—Ä—Ö —Å–∏–¥—è',category:'–ü–ª–µ—á–∏'},
      {id:'e12',name:'–¢—Ä–∏—Ü–µ–ø—Å –Ω–∞ –±–ª–æ–∫–µ',category:'–¢—Ä–∏—Ü–µ–ø—Å'},
    ];
    state.programs=[
      {id:'p1',name:'–°–ø–∏–Ω–∞',icon:'ü¶æ',exerciseIds:['e1','e2','e3']},
      {id:'p2',name:'–ù–æ–≥–∏',icon:'ü¶µ',exerciseIds:['e6','e7','e8']},
      {id:'p3',name:'–ì—Ä—É–¥—å',icon:'üí™',exerciseIds:['e4','e5']},
      {id:'p4',name:'–ü–ª–µ—á–∏ / –ë–∏—Ü–µ–ø—Å',icon:'üèãÔ∏è',exerciseIds:['e10','e11','e9']},
    ];
    save();
  }
}

// ---- EXPORT / IMPORT ----
function openExportModal(){openModal('modal-export');}

function exportData(){
  const json=JSON.stringify(state,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  const d=new Date();
  a.download=`gains-backup-${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}.json`;
  a.click();
  URL.revokeObjectURL(url);
  // Save last export date
  localStorage.setItem('gains_last_export', Date.now().toString());
  showToast('‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω!');
  updateExportReminder();
}

function importData(input){
  const file=input.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=(e)=>{
    try{
      const parsed=JSON.parse(e.target.result);
      if(!parsed.exercises||!parsed.programs||!parsed.workouts){showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');return;}
      if(!confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –∑–∞–º–µ–Ω–∏—Ç ${state.workouts.length} —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫.`))return;
      state={exercises:[],programs:[],workouts:[],...parsed};
      save();
      closeModal('modal-export');
      renderHome();
      showToast('‚úÖ –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!');
    }catch(err){showToast('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');}
  };
  reader.readAsText(file);
}

function updateExportReminder(){
  const lastExport=localStorage.getItem('gains_last_export');
  const banner=document.getElementById('export-reminder');
  if(!banner)return;
  // Show if never exported, or last export > 7 days ago
  const shouldShow=!lastExport||(Date.now()-parseInt(lastExport))>7*86400000;
  banner.style.display=shouldShow&&state.workouts.length>0?'block':'none';
}

// ---- UTILS ----
function formatDate(ts){
  const d=new Date(ts);
  const days=['–í—Å','–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±'];
  const months=['—è–Ω–≤','—Ñ–µ–≤','–º–∞—Ä','–∞–ø—Ä','–º–∞–π','–∏—é–Ω','–∏—é–ª','–∞–≤–≥','—Å–µ–Ω','–æ–∫—Ç','–Ω–æ—è','–¥–µ–∫'];
  return `${days[d.getDay()]} ${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
}
function formatTime(sec){return `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;}
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400);}
function closeModal(id){document.getElementById(id).classList.remove('open');}
function openModal(id){const el=document.getElementById(id);el.classList.add('open');el.onclick=(e)=>{if(e.target===el)closeModal(id);};}
function getEx(id){return state.exercises.find(e=>e.id===id);}

const tabs=['home','history','programs'];
function switchTab(tab){
  tabs.forEach(t=>{
    document.getElementById(`screen-${t}`).classList.toggle('active',t===tab);
    const nb=document.getElementById(`nav-${t}`);
    if(nb)nb.classList.toggle('active',t===tab);
  });
  if(tab==='home')renderHome();
  if(tab==='history')renderHistory();
  if(tab==='programs')renderPrograms();
}

// ---- HOME ----
function renderHome(){
  document.getElementById('home-date').textContent=formatDate(Date.now());
  updateExportReminder();
  const pl=document.getElementById('home-programs-list');
  pl.innerHTML=state.programs.slice(0,4).map(p=>`
    <div class="prog-card" onclick="startWorkoutWithProgram('${p.id}')">
      <div class="prog-icon">${p.icon||'üèãÔ∏è'}</div>
      <div class="prog-info"><div class="prog-name">${p.name}</div><div class="prog-exercises">${p.exerciseIds.map(id=>getEx(id)?.name||'?').join(' ¬∑ ')}</div></div>
      <div style="font-size:20px;color:var(--muted)">‚ñ∂</div>
    </div>`).join('')||`<div style="padding:0 20px;"><div class="card" style="text-align:center;color:var(--muted);font-size:13px;">–ù–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º. <span style="color:var(--accent);cursor:pointer;" onclick="switchTab('programs')">–°–æ–∑–¥–∞—Ç—å ‚Üí</span></div></div>`;

  const lw=document.getElementById('home-last-workout');
  const last=state.workouts.slice().sort((a,b)=>b.date-a.date)[0];
  lw.innerHTML=last?`
    <div class="hist-card" onclick="showHistDetail('${last.id}')">
      <div class="hist-card-top"><div class="hist-card-name">${last.programName||'–°–≤–æ–±–æ–¥–Ω–∞—è'}</div><div class="hist-card-time">${formatDate(last.date)}</div></div>
      <div class="hist-card-exercises">${last.exercises.map(e=>e.name).join(', ')}</div>
      <div class="hist-card-stats">
        <div class="hist-stat"><span>${last.exercises.length}</span> —É–ø—Ä</div>
        <div class="hist-stat"><span>${last.exercises.reduce((s,e)=>s+e.sets.filter(x=>x.done).length,0)}</span> –ø–æ–¥—Ö</div>
        <div class="hist-stat"><span>${formatTime(last.duration||0)}</span></div>
      </div>
    </div>`:
    `<div style="padding:0 20px;"><div class="card" style="text-align:center;color:var(--muted);font-size:13px;">–ï—â—ë –Ω–µ –±—ã–ª–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div></div>`;

  const now=Date.now();
  document.getElementById('stat-total').textContent=state.workouts.length;
  document.getElementById('stat-week').textContent=state.workouts.filter(w=>w.date>now-7*86400000).length;
  const dates=[...new Set(state.workouts.map(w=>new Date(w.date).toDateString()))].sort().reverse();
  let streak=0,cur=new Date();cur.setHours(0,0,0,0);
  for(const d of dates){const dd=new Date(d);if(dd.getTime()===cur.getTime()||dd.getTime()===cur.getTime()-86400000){streak++;cur=new Date(dd.getTime()-86400000);}else break;}
  document.getElementById('stat-streak').textContent=streak;
}

// ---- EXERCISES ----
function renderExLibModal(){
  const q=document.getElementById('exlib-search').value.toLowerCase();
  const list=document.getElementById('exlib-modal-list');
  const filtered=state.exercises.filter(e=>e.name.toLowerCase().includes(q));
  list.innerHTML=filtered.length?filtered.map(e=>`
    <div class="exlib-item">
      <div><div class="exlib-name">${e.name}</div><div class="exlib-cat">${e.category}</div></div>
      <div onclick="deleteExercise('${e.id}')" style="width:28px;height:28px;border-radius:50%;background:var(--s2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;color:var(--danger);">‚úï</div>
    </div>`).join(''):
    '<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
}

function openExerciseLibModal(){
  document.getElementById('exlib-search').value='';
  renderExLibModal();
  renderCatPicker('cat-picker','new-ex-cat');
  openModal('modal-exlib');
}

function renderCatPicker(pickerId,valId){
  const picker=document.getElementById(pickerId);
  const curVal=document.getElementById(valId).value||CATEGORIES[0];
  picker.innerHTML=CATEGORIES.map(c=>`
    <div class="chip${c===curVal?' selected':''}" onclick="selectCat(this,'${c}','${valId}','${pickerId}')">${c}</div>`).join('');
}

function selectCat(el,cat,valId,pickerId){
  document.querySelectorAll(`#${pickerId} .chip`).forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById(valId).value=cat;
}

function createExercise(){
  const name=document.getElementById('new-ex-name').value.trim();
  if(!name){showToast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
  const cat=document.getElementById('new-ex-cat').value||'–î—Ä—É–≥–æ–µ';
  state.exercises.push({id:uid(),name,category:cat});
  save();
  document.getElementById('new-ex-name').value='';
  renderExLibModal();
  if(pickExTarget)renderPickExModal();
  showToast('‚úÖ –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ');
}

function deleteExercise(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ?'))return;
  state.exercises=state.exercises.filter(e=>e.id!==id);
  save();renderExLibModal();showToast('–£–¥–∞–ª–µ–Ω–æ');
}

// ---- PICK EXERCISE ----
function renderPickExModal(){
  const q=document.getElementById('pick-ex-search').value.toLowerCase();
  const cats=document.getElementById('pick-ex-cats');
  cats.innerHTML=['–í—Å–µ',...CATEGORIES].map(c=>`
    <div class="chip${pickExCat===(c==='–í—Å–µ'?'':c)?' selected':''}" onclick="setPickCat('${c==='–í—Å–µ'?'':c}')">${c}</div>`).join('');
  const filtered=state.exercises.filter(e=>(!q||e.name.toLowerCase().includes(q))&&(!pickExCat||e.category===pickExCat));
  const list=document.getElementById('pick-ex-list');
  list.innerHTML=filtered.length?filtered.map(e=>`
    <div class="exlib-item" style="cursor:pointer;" onclick="pickExercise('${e.id}')">
      <div><div class="exlib-name">${e.name}</div><div class="exlib-cat">${e.category}</div></div>
      <div style="font-size:20px;color:var(--accent);">Ôºã</div>
    </div>`).join(''):
    '<div style="color:var(--muted);font-size:13px;text-align:center;padding:20px">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
}

function setPickCat(cat){pickExCat=cat;renderPickExModal();}

function openPickExerciseModal(target){
  pickExTarget=target;pickExCat='';
  document.getElementById('pick-ex-search').value='';
  renderPickExModal();
  openModal('modal-pick-ex');
}

function pickExercise(exId){
  if(pickExTarget==='program'){
    if(!tempProgExercises.includes(exId)){tempProgExercises.push(exId);renderProgExList();}
    else showToast('–£–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ');
  }else if(pickExTarget==='workout'){
    addExerciseToActiveWorkout(exId);
    closeModal('modal-pick-ex');
  }
}

// ---- PROGRAMS ----
function renderPrograms(){
  const list=document.getElementById('programs-list');
  list.innerHTML=state.programs.length?state.programs.map(p=>`
    <div class="prog-card">
      <div class="prog-icon" onclick="startWorkoutWithProgram('${p.id}')">${p.icon||'üèãÔ∏è'}</div>
      <div class="prog-info" onclick="startWorkoutWithProgram('${p.id}')">
        <div class="prog-name">${p.name}</div>
        <div class="prog-exercises">${p.exerciseIds.map(id=>getEx(id)?.name||'?').join(' ¬∑ ')}</div>
      </div>
      <div class="prog-actions">
        <div class="prog-act-btn" onclick="editProgram('${p.id}')">‚úèÔ∏è</div>
        <div class="prog-act-btn" onclick="deleteProgram('${p.id}')" style="color:var(--danger)">üóë</div>
      </div>
    </div>`).join(''):
    `<div class="empty-state"><div class="icon">üìã</div><p>–ù–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º.<br>–°–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é!</p></div>`;

  const prev=document.getElementById('exercises-preview');
  prev.innerHTML=state.exercises.slice(0,6).map(e=>`
    <div class="exlib-item" style="margin:0 20px 8px;">
      <div><div class="exlib-name">${e.name}</div><div class="exlib-cat">${e.category}</div></div>
    </div>`).join('')+(state.exercises.length>6?`<div style="padding:0 20px;font-size:12px;color:var(--muted);margin-bottom:8px;">‚Ä¶–µ—â—ë ${state.exercises.length-6} —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–π</div>`:'');
}

function openNewProgramModal(){
  editingProgramId=null;tempProgExercises=[];
  document.getElementById('prog-name-input').value='';
  document.getElementById('prog-icon-val').value='üèãÔ∏è';
  document.getElementById('modal-prog-title').textContent='–ù–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞';
  renderProgExList();renderIconPicker();
  openModal('modal-new-program');
}

function editProgram(id){
  const p=state.programs.find(x=>x.id===id);if(!p)return;
  editingProgramId=id;tempProgExercises=[...p.exerciseIds];
  document.getElementById('prog-name-input').value=p.name;
  document.getElementById('prog-icon-val').value=p.icon||'üèãÔ∏è';
  document.getElementById('modal-prog-title').textContent='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
  renderProgExList();renderIconPicker();
  openModal('modal-new-program');
}

function renderIconPicker(){
  const cur=document.getElementById('prog-icon-val').value;
  document.getElementById('icon-picker').innerHTML=ICONS.map(ic=>`
    <div style="width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;background:${ic===cur?'var(--accent)':'var(--s2)'};border:2px solid ${ic===cur?'var(--accent)':'var(--border)'};" onclick="selectIcon('${ic}')">${ic}</div>`).join('');
}

function selectIcon(ic){document.getElementById('prog-icon-val').value=ic;renderIconPicker();}

function renderProgExList(){
  const el=document.getElementById('prog-ex-list');
  el.innerHTML=tempProgExercises.map((exId,i)=>{
    const ex=getEx(exId)||{name:'?',category:''};
    return `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;background:var(--s2);border:1px solid var(--border);border-radius:10px;padding:10px 12px;">
        <div style="flex:1;"><div style="font-size:14px;font-weight:500;">${ex.name}</div><div style="font-size:11px;color:var(--muted);">${ex.category}</div></div>
        <div style="display:flex;gap:4px;">
          ${i>0?`<div class="prog-act-btn" onclick="moveProgEx(${i},-1)" style="font-size:11px;">‚Üë</div>`:''}
          ${i<tempProgExercises.length-1?`<div class="prog-act-btn" onclick="moveProgEx(${i},1)" style="font-size:11px;">‚Üì</div>`:''}
          <div class="prog-act-btn" onclick="removeProgEx(${i})" style="color:var(--danger);">‚úï</div>
        </div>
      </div>`;
  }).join('');
  document.getElementById('prog-ex-count').textContent=tempProgExercises.length;
}

function moveProgEx(i,dir){const j=i+dir;if(j<0||j>=tempProgExercises.length)return;[tempProgExercises[i],tempProgExercises[j]]=[tempProgExercises[j],tempProgExercises[i]];renderProgExList();}
function removeProgEx(i){tempProgExercises.splice(i,1);renderProgExList();}

function saveProgram(){
  const name=document.getElementById('prog-name-input').value.trim();
  if(!name){showToast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ');return;}
  const icon=document.getElementById('prog-icon-val').value;
  if(editingProgramId){
    const p=state.programs.find(x=>x.id===editingProgramId);
    if(p){p.name=name;p.icon=icon;p.exerciseIds=[...tempProgExercises];}
  }else{
    state.programs.push({id:uid(),name,icon,exerciseIds:[...tempProgExercises]});
  }
  save();closeModal('modal-new-program');renderPrograms();renderHome();showToast('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
}

function deleteProgram(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É?'))return;
  state.programs=state.programs.filter(p=>p.id!==id);
  save();renderPrograms();showToast('–£–¥–∞–ª–µ–Ω–æ');
}

// ---- START WORKOUT ----
function openStartWorkoutModal(){
  const list=document.getElementById('start-programs-list');
  list.innerHTML=state.programs.map(p=>`
    <div class="prog-card" onclick="startWorkoutWithProgram('${p.id}');closeModal('modal-start');" style="margin:0 0 10px;">
      <div class="prog-icon">${p.icon||'üèãÔ∏è'}</div>
      <div class="prog-info"><div class="prog-name">${p.name}</div><div class="prog-exercises">${p.exerciseIds.map(id=>getEx(id)?.name||'?').join(' ¬∑ ')}</div></div>
    </div>`).join('')||'<div style="color:var(--muted);font-size:13px;text-align:center;padding:16px">–ù–µ—Ç –ø—Ä–æ–≥—Ä–∞–º–º</div>';
  openModal('modal-start');
}

function getLastWorkoutForExercise(exId,beforeDate){
  return state.workouts
    .filter(w=>w.date<(beforeDate||Date.now())&&w.exercises.some(e=>e.exerciseId===exId))
    .sort((a,b)=>b.date-a.date)[0]||null;
}

function getLastSetsForExercise(exId,beforeDate){
  const wk=getLastWorkoutForExercise(exId,beforeDate);
  if(!wk)return null;
  return wk.exercises.find(e=>e.exerciseId===exId)||null;
}

function startWorkoutWithProgram(programId){
  closeModal('modal-start');
  const prog=state.programs.find(p=>p.id===programId);if(!prog)return;
  const now=Date.now();
  const exercises=prog.exerciseIds.map(exId=>{
    const ex=getEx(exId)||{id:exId,name:'?',category:''};
    const prevExData=getLastSetsForExercise(exId,now);
    const prevSets=prevExData?.sets||null;
    const prevNote=prevExData?.note||'';
    const sets=prevSets
      ?prevSets.map(s=>({reps:'',weight:'',done:false,prevReps:s.reps,prevWeight:s.weight}))
      :[{reps:'',weight:'',done:false,prevReps:null,prevWeight:null},{reps:'',weight:'',done:false,prevReps:null,prevWeight:null},{reps:'',weight:'',done:false,prevReps:null,prevWeight:null}];
    return{exerciseId:exId,name:ex.name,sets,prevSets,prevNote,note:''};
  });
  beginActiveWorkout({programId,programName:prog.name,exercises,startTime:now});
}

function startFreeWorkout(){closeModal('modal-start');beginActiveWorkout({programId:null,programName:'–°–≤–æ–±–æ–¥–Ω–∞—è',exercises:[],startTime:Date.now()});}

function beginActiveWorkout(data){
  activeWorkout={...data,duration:0};
  let elapsed=0;
  activeWorkout.timerInterval=setInterval(()=>{elapsed++;document.getElementById('aw-timer').textContent=formatTime(elapsed);activeWorkout.duration=elapsed;},1000);
  document.getElementById('aw-program-name').textContent=data.programName;
  document.getElementById('aw-timer').textContent='00:00';
  renderActiveWorkout();
  tabs.forEach(t=>document.getElementById(`screen-${t}`).classList.remove('active'));
  document.getElementById('screen-workout').classList.add('active');
  document.getElementById('main-nav').style.display='none';
}

function renderActiveWorkout(){
  const container=document.getElementById('aw-exercises');
  container.innerHTML=activeWorkout.exercises.map((ex,ei)=>renderExBlock(ei)).join('');
}

function renderExBlock(ei){
  const ex=activeWorkout.exercises[ei];
  const prevSummary=ex.prevSets?ex.prevSets.map(s=>`${s.reps}–ø√ó${s.weight}–∫–≥`).join('  '):'–ø–µ—Ä–≤—ã–π —Ä–∞–∑';
  const prevNoteHtml=ex.prevNote?`<div style="font-size:11px;color:var(--orange);margin-top:2px;">üìù ${ex.prevNote}</div>`:'';
  return `
    <div class="ex-block" id="ex-block-${ei}">
      <div class="ex-block-head">
        <div style="flex:1;min-width:0;">
          <div class="ex-block-name">${ex.name}</div>
          <div class="ex-block-prev">üïê ${prevSummary}</div>
          ${prevNoteHtml}
        </div>
        <div onclick="removeExFromWorkout(${ei})" style="width:28px;height:28px;border-radius:50%;background:var(--s2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;color:var(--muted);flex-shrink:0;margin-left:8px;">‚úï</div>
      </div>
      <div class="sets-table">
        <div class="sets-row sets-head"><div></div><div>–ü–æ–≤—Ç–æ—Ä—ã</div><div>–í–µ—Å –∫–≥</div><div></div></div>
        ${ex.sets.map((s,si)=>`
          <div class="sets-row">
            <div class="set-n ${s.done?'done':''}" id="sn-${ei}-${si}">${si+1}</div>
            <input type="number" inputmode="decimal" class="set-input" id="si-r-${ei}-${si}"
              value="${s.reps}" placeholder="${s.prevReps||'‚Äî'}"
              onchange="updateSet(${ei},${si},'reps',this.value)" min="0">
            <input type="number" inputmode="decimal" class="set-input" id="si-w-${ei}-${si}"
              value="${s.weight}" placeholder="${s.prevWeight||'‚Äî'}"
              onchange="updateSet(${ei},${si},'weight',this.value)" min="0" step="0.5">
            <button class="check-set ${s.done?'done':''}" id="cs-${ei}-${si}" onclick="toggleSet(${ei},${si})">‚úì</button>
          </div>`).join('')}
      </div>
      <button class="add-set-btn" onclick="addSetToEx(${ei})">+ –ü–æ–¥—Ö–æ–¥</button>
      <div class="note-row">
        <textarea class="note-input" id="note-${ei}" placeholder="üìù –ó–∞–º–µ—Ç–∫–∞ –∫ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—é (–æ—â—É—â–µ–Ω–∏—è, —Ç–µ—Ö–Ω–∏–∫–∞, –ø–ª–∞–Ω—ã‚Ä¶)" onchange="updateNote(${ei},this.value)">${ex.note||''}</textarea>
      </div>
    </div>`;
}

function updateSet(ei,si,field,val){if(!activeWorkout)return;activeWorkout.exercises[ei].sets[si][field]=val;}
function updateNote(ei,val){if(!activeWorkout)return;activeWorkout.exercises[ei].note=val;}

function toggleSet(ei,si){
  if(!activeWorkout)return;
  const s=activeWorkout.exercises[ei].sets[si];
  const ri=document.getElementById(`si-r-${ei}-${si}`);
  const wi=document.getElementById(`si-w-${ei}-${si}`);
  if(!s.reps&&ri.placeholder&&ri.placeholder!=='‚Äî'){s.reps=ri.placeholder;ri.value=s.reps;}
  if(!s.weight&&wi.placeholder&&wi.placeholder!=='‚Äî'){s.weight=wi.placeholder;wi.value=s.weight;}
  s.done=!s.done;
  document.getElementById(`sn-${ei}-${si}`).className=`set-n ${s.done?'done':''}`;
  document.getElementById(`cs-${ei}-${si}`).className=`check-set ${s.done?'done':''}`;
}

function addSetToEx(ei){
  if(!activeWorkout)return;
  const ex=activeWorkout.exercises[ei];
  // Save current note before re-render
  const noteEl=document.getElementById(`note-${ei}`);
  if(noteEl)ex.note=noteEl.value;
  const lastSet=ex.sets[ex.sets.length-1];
  ex.sets.push({reps:'',weight:'',done:false,prevReps:lastSet?.prevReps||null,prevWeight:lastSet?.prevWeight||null});
  const old=document.getElementById(`ex-block-${ei}`);
  old.outerHTML=renderExBlock(ei);
}

function removeExFromWorkout(ei){if(!activeWorkout)return;activeWorkout.exercises.splice(ei,1);renderActiveWorkout();}
function addExToWorkout(){openPickExerciseModal('workout');}

function addExerciseToActiveWorkout(exId){
  if(!activeWorkout)return;
  const ex=getEx(exId)||{id:exId,name:'?',category:''};
  const prevExData=getLastSetsForExercise(exId,Date.now());
  const prevSets=prevExData?.sets||null;
  const prevNote=prevExData?.note||'';
  const sets=prevSets?prevSets.map(s=>({reps:'',weight:'',done:false,prevReps:s.reps,prevWeight:s.weight})):[{reps:'',weight:'',done:false},{reps:'',weight:'',done:false},{reps:'',weight:'',done:false}];
  activeWorkout.exercises.push({exerciseId:exId,name:ex.name,sets,prevSets,prevNote,note:''});
  renderActiveWorkout();
  const container=document.getElementById('aw-exercises');
  container.scrollTop=container.scrollHeight;
  showToast(`+ ${ex.name}`);
}

function finishWorkout(){
  if(!activeWorkout)return;
  // Save all notes from DOM before finishing
  activeWorkout.exercises.forEach((ex,ei)=>{
    const noteEl=document.getElementById(`note-${ei}`);
    if(noteEl)ex.note=noteEl.value;
  });
  clearInterval(activeWorkout.timerInterval);
  const wk={
    id:uid(),programId:activeWorkout.programId,programName:activeWorkout.programName,
    date:activeWorkout.startTime,duration:activeWorkout.duration||0,
    exercises:activeWorkout.exercises.map(e=>({
      exerciseId:e.exerciseId,name:e.name,note:e.note||'',
      sets:e.sets.map(s=>({reps:s.reps||s.prevReps||0,weight:s.weight||s.prevWeight||0,done:s.done}))
    }))
  };
  state.workouts.push(wk);save();
  activeWorkout=null;exitWorkoutScreen();
  showToast('üéâ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!');
}

function cancelWorkout(){
  if(!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É? –î–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è.'))return;
  clearInterval(activeWorkout?.timerInterval);
  activeWorkout=null;exitWorkoutScreen();
}

function exitWorkoutScreen(){
  document.getElementById('screen-workout').classList.remove('active');
  document.getElementById('main-nav').style.display='flex';
  switchTab('home');
}

// ---- HISTORY ----
function renderHistory(){
  const list=document.getElementById('history-list');
  if(!state.workouts.length){list.innerHTML=`<div class="empty-state"><div class="icon">üì≠</div><p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞.<br>–ü—Ä–æ–≤–µ–¥–∏ –ø–µ—Ä–≤—É—é —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É!</p></div>`;return;}
  const sorted=state.workouts.slice().sort((a,b)=>b.date-a.date);
  const groups={};
  sorted.forEach(w=>{const d=new Date(w.date);const key=`${d.getFullYear()}-${String(d.getMonth()).padStart(2,'0')}`;if(!groups[key])groups[key]=[];groups[key].push(w);});
  const months=['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'];
  list.innerHTML=Object.entries(groups).sort((a,b)=>b[0].localeCompare(a[0])).map(([key,wks])=>{
    const[y,m]=key.split('-');
    return`<div class="hist-date">${months[+m]} ${y}</div>`+
      wks.map(w=>`
        <div class="hist-card" onclick="showHistDetail('${w.id}')">
          <div class="hist-card-top"><div class="hist-card-name">${w.programName||'–°–≤–æ–±–æ–¥–Ω–∞—è'}</div><div class="hist-card-time">${formatDate(w.date)}</div></div>
          <div class="hist-card-exercises">${w.exercises.map(e=>e.name).join(', ')}</div>
          <div class="hist-card-stats">
            <div class="hist-stat"><span>${w.exercises.length}</span> —É–ø—Ä</div>
            <div class="hist-stat"><span>${w.exercises.reduce((s,e)=>s+e.sets.filter(x=>x.done).length,0)}</span> –ø–æ–¥—Ö</div>
            <div class="hist-stat"><span>${formatTime(w.duration||0)}</span></div>
          </div>
        </div>`).join('');
  }).join('');
}

function showHistDetail(id){
  const w=state.workouts.find(x=>x.id===id);if(!w)return;
  currentHistDetailId=id;
  document.getElementById('hist-detail-content').innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;">${w.programName||'–°–≤–æ–±–æ–¥–Ω–∞—è'}</div>
      <div class="badge">${formatTime(w.duration||0)}</div>
    </div>
    <div style="font-size:12px;color:var(--muted);margin-bottom:16px;">${formatDate(w.date)}</div>
    ${w.exercises.map(e=>`
      <div style="margin-bottom:16px;background:var(--s2);border-radius:12px;padding:12px 14px;">
        <div style="font-weight:600;font-size:14px;margin-bottom:8px;color:var(--accent);">${e.name}</div>
        ${e.sets.map((s,i)=>`
          <div style="display:flex;gap:16px;margin-bottom:5px;font-size:13px;color:${s.done?'var(--text)':'var(--muted)'};">
            <span style="color:var(--muted);min-width:60px;">–ü–æ–¥—Ö–æ–¥ ${i+1}</span>
            <span>${s.reps} –ø–æ–≤—Ç</span>
            <span>${s.weight} –∫–≥</span>
            ${s.done?'<span style="color:var(--green);">‚úì</span>':'<span style="color:var(--muted);">‚Äî</span>'}
          </div>`).join('')}
        ${e.note?`<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:12px;color:var(--orange);">üìù ${e.note}</div>`:''}
      </div>`).join('')}`;
  openModal('modal-hist-detail');
}

function deleteWorkoutFromDetail(){
  if(!currentHistDetailId||!confirm('–£–¥–∞–ª–∏—Ç—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫—É?'))return;
  state.workouts=state.workouts.filter(w=>w.id!==currentHistDetailId);
  save();closeModal('modal-hist-detail');renderHistory();renderHome();showToast('–£–¥–∞–ª–µ–Ω–æ');
}

// ---- INIT ----
load();
renderHome();
</script>
</body>
</html>
